---
title: 记一个政府网址爬虫
date: 2018-11-07 22:05:27
tags: 爬虫
---

政府网站信息库 （ http://114.55.181.28/databaseInfo/download ） 能下载各政府部门网站url，写个爬虫自动下载。

信息库分两个部分下载，一是国务院各部门，二是各省市部门。

<!-- more -->

**国务院各部门**：

查看headers，下载时POST到 http://114.55.181.28/downloadTemp_downFile.action ，form_data为downames:bm05，response为 一个.zip。

审查元素bm05来自:

```html
<div class="dpage_btn dpage_btn_click active" id="bm05" onclick="_trackData.push(['addaction','全国政府网站基本信息数据库', '教育部'])">教育部</div>
```

所以，用requests进行GET/POST，lxml解析出各部门id。

```python
headers = {"User-Agent": "Mozilla/5.0 (Windows NT 6.1; Win64; x64)           			AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 				   Safari/537.36"}
html_r = requests.get('http://114.55.181.28/databaseInfo/download', headers=headers)
# lxml+cssselect解析html
tree = lxml.html.fromstring(html_r.text)
fixed_html = lxml.html.tostring(tree, pretty_print=True)
divs_guowuyuan = tree.cssselect('div[class="dpage_btn dpage_btn_click"]')
for div in divs_guowuyuan:
    # 各部门id
    id = div.attrib.get('id')
    # 各部门名称
    name = div.text
    file_path = '%s\%s.zip'% (guowuyuan_base_path,name)
    download(id,file_path)
    
def download(id, file_path):
    form_data = {"downames": id}
    r = requests.post('http://114.55.181.28/downloadTemp_downFile.action',                          data=form_data, headers=headers)
    content = r.content
    fw = open(file_path, 'wb')
    fw.write(content)
```

**各省市部门**：

下载时POST到 http://114.55.181.28/downloadTemp_downFile.action ，form_data为 downames: 110101，response为 一个.zip。

审查元素，110101来自:

```html
<div id="county_110101" class="d_con_sub active" onclick="_trackData.push(['addaction','全国政府网站基本信息数据库', '东城区'])"><span>东城区</span>(69)</div>
```

如果解析当前html只能获取北京市的各区id。抓包发现，选择天津市时，通过POST到 http://114.55.181.28/databaseInfo_citiesInfo.action  获取天津市各区id，form_data为provinceCode: 120000；同样，选择浙江省时，通过POST到 http://114.55.181.28/databaseInfo_citiesInfo.action  获取浙江省各市、县id，form_data为provinceCode: 330000。

审查元素，发现120000来自:

```html
<option value="120000" onclick=" _trackData.push([&quot;addaction&quot;,&quot;全国政府网站基本信息数据库&quot;, &quot;天津市&quot;])">天津市</option>
```

330000同样。

所以，用lxml解析出各省、直辖市value值，然后POST到databaseInfo_citiesInfo.action获取市、区一级id，然后POST到downloadTemp_downFile.action进行下载。有个问题是直辖市、新疆生产建设兵团是“直辖市-区”两级，省是“省-市-县”三级，解析response时要区别对待。